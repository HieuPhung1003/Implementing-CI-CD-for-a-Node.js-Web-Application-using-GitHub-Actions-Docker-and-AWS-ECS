name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout code
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. Set up Node.js
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    # 3. Build Docker image
    - name: Build Docker image
      run: |
        docker build -t webapp-ci-cd .

    # 4. Login to AWS ECR
    - name: Login to AWS ECR
      uses: aws-actions/amazon-ecr-login@v1

    # 5. Tag and push Docker image
    - name: Push Docker image to ECR
      run: |
        IMAGE_URI=123456789012.dkr.ecr.us-east-1.amazonaws.com/webapp-ci-cd:latest
        docker tag webapp-ci-cd:latest $IMAGE_URI
        docker push $IMAGE_URI

    # 6. Deploy to ECS
    - name: Deploy to ECS
      uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      with:
        cluster: webapp-cluster
        service: webapp-service
        task-definition: ecs-task-def.json
        wait-for-service-stability: true
